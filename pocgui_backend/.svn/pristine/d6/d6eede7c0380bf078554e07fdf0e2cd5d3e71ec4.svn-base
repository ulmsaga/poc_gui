<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mobigen.cdev.mapper.mysql.module.datamanages">
  <select id="getNmsInfoList" parameterType="map" resultType="com.mobigen.cdev.datagw.module.datamanages.nmsinfo.dto.NmsInfoManageDto">
    <include refid='sqlGetNmsInfoList' />
  </select>

	<sql id="sqlGetNmsInfoList">
		SELECT
				A.system_cd 
			,	A.system_nm
			,	IFNULL(B.charge_info, '-') charge_info
			,	IFNULL(A.description , '-') description
			,	IFNULL(B.user_name, '-') user_name
			,	IFNULL(B.user_id, '-') user_id
			,	IFNULL(B.team_name, '-') team_name
			,	IFNULL(B.phone, '-') phone
			FROM system_code A
			LEFT OUTER JOIN 
				(
					SELECT
						system_cd
					,	LTRIM(GROUP_CONCAT(CONCAT(' ', B.user_name, '(', A.user_id, ' ', phone, ' ', team_name, ')'  ) ORDER BY B.user_name)) charge_info
					,	LTRIM(GROUP_CONCAT(CONCAT(B.user_name) ORDER BY B.user_name)) user_name
					,	LTRIM(GROUP_CONCAT(CONCAT(A.user_id) ORDER BY B.user_name)) user_id
					,	LTRIM(GROUP_CONCAT(CONCAT(team_name) ORDER BY B.user_name)) team_name
					,	LTRIM(GROUP_CONCAT(CONCAT(phone) ORDER BY B.user_name)) phone
					FROM
						system_code_manager_map A
					LEFT OUTER JOIN	(SELECT user_id, user_name, team_name, phone FROM system_manager WHERE use_yn = 'Y') B
					ON A.user_id = B.user_id
					WHERE 1 = 1
					GROUP BY system_cd 
				) B
			ON A.system_cd = B.system_cd
			WHERE A.use_yn = 'Y'
			AND A.system_cd  != '2000'
			<if test = 'nmsList != null and nmsList.size != 0' >
				AND A.system_cd IN <foreach item="item" index="index" collection="nmsList" open="(" separator="," close=")">#{item}</foreach>
			</if>
			<if test = 'managerList != null and managerList.size != 0' >
				AND B.user_name IN <foreach item="item" index="index" collection="managerList" open="(" separator="," close=")">#{item}</foreach>
			</if>
			<if test = 'teamInfo neq "" and teamInfo neq null' >
				AND B.team_name like CONCAT(CONCAT('%', #{teamInfo}), '%')
			</if>
			ORDER BY system_cd
	</sql>

	<update id = "getEditNmsInfo">
		UPDATE system_code 
			SET 
			<if test = 'nmsNm neq "" and nmsNm neq null'>
			system_nm = #{nmsNm}
			</if>
			<if test = 'nmsDesc neq "" and nmsDesc neq null'>
			, description = #{nmsDesc}
			</if>
			, updated_at = NOW()
			WHERE 1=1 
		 	AND system_cd = #{nmsId}
	</update>

	<insert id ="getInsertNmsInfo">
	 INSERT into system_code (system_cd, system_nm, description, use_yn, created_at, updated_at)
	 VALUES 
	 	(
			#{nmsId}
		, #{nmsNm}
		, #{nmsDesc}
		, 'Y'
		, default
		, default
		)
	</insert>

	<select id ="getSelectNmsId" parameterType="map" resultType="map">
		select system_cd 
		from system_code
		order by system_cd desc
	</select>

	<select id="getNmsInfoListExcel" parameterType="map" resultType="java.util.HashMap">
		<include refid='sqlGetNmsInfoList' />
	</select>
</mapper>