<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mobigen.cdev.mapper.mysql.module.manage">
  <!---->
  <!---->
  <select id="getUserInfoList" parameterType="map" resultType="com.mobigen.cdev.datagw.module.manage.dto.UserInfoManageDto">
    <include refid='com.mobigen.cdev.mapper.mysql.core.paging.pagingPreSQL' />
    <include refid='sqlGetUserInfoList' />
    <include refid='com.mobigen.cdev.mapper.mysql.core.paging.pagingPostSQL' />
  </select>

  <select id="getUserInfoListExcel" parameterType="map" resultType="java.util.HashMap">
		<include refid='sqlGetUserInfoList' />
	</select>

  <sql id="sqlGetUserInfoList">
    SELECT
        user_id,
        user_name,
        CONCAT(SUBSTRING(phone, 1, 3), '-', SUBSTRING(phone, 4,4), '-', SUBSTRING(phone,8)) AS phone,
        email,
        team_name
    FROM
      system_manager
    WHERE 1=1 
      AND use_yn = 'Y'
      <if test = 'userId neq "" and userId neq null' >
        AND user_id like CONCAT(CONCAT('%', #{userId}), '%')
      </if>
      <if test = 'userNm neq "" and userNm neq null' >
        AND user_name like CONCAT(CONCAT('%', #{userNm}), '%')
      </if>
      <if test = 'teamInfo neq "" and teamInfo neq null' >
        AND team_name like CONCAT(CONCAT('%', #{teamInfo}), '%')
      </if>
  </sql>


  <!---->
  <!---->
  <select id="getNmsInfoList" parameterType="map" resultType="com.mobigen.cdev.datagw.module.manage.dto.NmsInfoManageDto">
    <include refid='sqlGetNmsInfoList' />
  </select>

	<sql id="sqlGetNmsInfoList">
		SELECT
				A.system_cd 
			,	A.system_nm
			,	IFNULL(B.charge_info, '-') charge_info
			,	IFNULL(A.description , '-') description
			,	IFNULL(B.user_name, '-') user_name
			,	IFNULL(B.user_id, '-') user_id
			,	IFNULL(B.team_name, '-') team_name
			,	IFNULL(B.phone, '-') phone
			FROM system_code A
			LEFT OUTER JOIN 
				(
					SELECT
						system_cd
					,	LTRIM(GROUP_CONCAT(CONCAT(' ', B.user_name, '(', A.user_id, ' ', phone, ' ', team_name, ')'  ) ORDER BY B.user_name)) charge_info
					,	LTRIM(GROUP_CONCAT(CONCAT(B.user_name) ORDER BY B.user_name)) user_name
					,	LTRIM(GROUP_CONCAT(CONCAT(A.user_id) ORDER BY B.user_name)) user_id
					,	LTRIM(GROUP_CONCAT(CONCAT(team_name) ORDER BY B.user_name)) team_name
					,	LTRIM(GROUP_CONCAT(CONCAT(phone) ORDER BY B.user_name)) phone
					FROM
						system_code_manager_map A
					LEFT OUTER JOIN	(SELECT user_id, user_name, team_name, phone FROM system_manager WHERE use_yn = 'Y') B
					ON A.user_id = B.user_id
					WHERE 1 = 1
					GROUP BY system_cd 
				) B
			ON A.system_cd = B.system_cd
			WHERE A.use_yn = 'Y'
			AND A.system_cd  != '2000'
			<if test = 'nmsList != null and nmsList.size != 0' >
				AND A.system_cd IN <foreach item="item" index="index" collection="nmsList" open="(" separator="," close=")">#{item}</foreach>
			</if>
			<if test = 'managerList != null and managerList.size != 0' >
				AND B.user_name IN <foreach item="item" index="index" collection="managerList" open="(" separator="," close=")">#{item}</foreach>
			</if>
			<if test = 'teamInfo neq "" and teamInfo neq null' >
				AND B.team_name like CONCAT(CONCAT('%', #{teamInfo}), '%')
			</if>
			ORDER BY system_cd
	</sql>

	<update id = "getEditNmsInfo">
		UPDATE system_code 
			SET 
			<if test = 'nmsNm neq "" and nmsNm neq null'>
			system_nm = #{nmsNm}
			</if>
			<if test = 'nmsDesc neq "" and nmsDesc neq null'>
			, description = #{nmsDesc}
			</if>
			, updated_at = NOW()
			WHERE 1=1 
		 	AND system_cd = #{nmsId}
	</update>

	<insert id ="getInsertNmsInfo">
	 INSERT into system_code (system_cd, system_nm, description, use_yn, created_at, updated_at)
	 VALUES 
	 	(
			#{nmsId}
		, #{nmsNm}
		, #{nmsDesc}
		, 'Y'
		, default
		, default
		)
	</insert>

	<select id ="getSelectNmsId" parameterType="map" resultType="map">
		select system_cd 
		from system_code
		order by system_cd desc
	</select>

	<select id="getNmsInfoListExcel" parameterType="map" resultType="java.util.HashMap">
		<include refid='sqlGetNmsInfoList' />
	</select>

  <!---->
  <!---->
  <select id="getNmsChargeManageList" parameterType="map" resultType="com.mobigen.cdev.datagw.module.manage.dto.NmsChargeManageDto">
    SELECT 
      A.system_cd 
    ,	A.system_nm
    , A.description
    , (
        SELECT
          LTRIM(GROUP_CONCAT(CONCAT(' ', B.user_name, '(', B.user_id, ' ', B.phone, ' ', B.team_name, ')'  ) ORDER BY B.user_name))
        FROM system_manager B
        WHERE 1=1 
        AND B.user_id IN 
        <foreach collection= "selectedItem" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>) AS charge_info
    , (
        SELECT
          LTRIM(GROUP_CONCAT(CONCAT(B.user_id ) ORDER BY B.user_name)) 
        FROM system_manager B
        WHERE 1=1 
        AND B.user_id IN 
         <foreach collection= "selectedItem" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>) AS user_id
    , (
        SELECT
          LTRIM(GROUP_CONCAT(CONCAT(B.phone ) ORDER BY B.user_name)) 
        FROM system_manager B
        WHERE 1=1 
        AND B.user_id IN 
         <foreach collection= "selectedItem" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>) AS phone
    , (
        SELECT
          LTRIM(GROUP_CONCAT(CONCAT(B.team_name ) ORDER BY B.user_name)) 
        FROM system_manager B
        WHERE 1=1 
        AND B.user_id IN 
        <foreach collection= "selectedItem" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>) AS team_name
    , (
        SELECT
          LTRIM(GROUP_CONCAT(CONCAT(B.user_name ) ORDER BY B.user_name)) 
        FROM system_manager B
        WHERE 1=1 
        AND B.user_id IN 
        <foreach collection= "selectedItem" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>) AS user_name
    FROM system_code A
    WHERE A.system_cd IN
      <foreach collection= "systemCode" item="code"  open="(" close=")" separator=",">
          #{code}
      </foreach>
    ORDER BY system_cd
  </select>

  <select id="getManagerChangeStatus" parameterType="map" resultType="com.mobigen.cdev.datagw.module.manage.dto.NmsChargeManageDto">
    SELECT
				A.system_cd 
			,	A.system_nm
			,	IFNULL(B.charge_info, '-') charge_info
			,	B.user_name
			,	B.team_name
			, B.user_id
			,	IFNULL(A.description , '-') description
			FROM system_code A
			LEFT OUTER JOIN 
				(
					SELECT
						system_cd
						,B.user_name user_name
						,B.team_name team_name
						,B.user_id user_id
					,	LTRIM(GROUP_CONCAT(CONCAT(' ', B.user_name, '(', A.user_id, ' ', phone, ' ', team_name, ')'  ) ORDER BY B.user_name)) charge_info
					FROM
						system_code_manager_map A
					LEFT OUTER JOIN	(SELECT user_id, user_name, team_name, phone FROM system_manager WHERE use_yn = 'Y') B
					ON A.user_id = B.user_id
					WHERE 1 = 1
					GROUP BY system_cd , user_name, team_name, user_id 
				) B
			ON A.system_cd = B.system_cd
      WHERE 
      <foreach collection= "selectedItem" item="item" separator=" AND ">
            B.user_id = #{item}
      </foreach>
      AND 
      <foreach collection= "systemCode" item="code" separator=" AND ">
            A.system_cd = #{code}
      </foreach>

  </select>

  <delete id = "getDeleteNmsChargeManageList" >
    DELETE FROM system_code_manager_map
    WHERE system_cd = #{systemCodeList}
  </delete>

  <insert id = "getInsertNmsChargeManageList" >
    INSERT IGNORE INTO system_code_manager_map (user_id, system_cd) 
    VALUES 
      <foreach collection= "userIdList" item="userId" separator=",">
           (#{userId}, #{systemCodeList} )
     </foreach> 
  </insert>

</mapper>