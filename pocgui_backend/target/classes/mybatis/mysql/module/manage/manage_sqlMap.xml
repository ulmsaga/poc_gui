<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mobigen.cdev.mapper.mysql.module.manage">

  <sql id="def_table_system_code">system_code</sql>
  <sql id="def_table_system_manager">system_manager</sql>
  <sql id="def_table_system_code_manager_map">system_code_manager_map</sql>

  <!---->
  <!---->
  <select id="getUserInfoList" parameterType="map" resultType="com.mobigen.cdev.poc.module.manage.dto.UserInfoManageDto">
    <include refid='com.mobigen.cdev.mapper.mysql.core.paging.pagingPreSQL' />
    <include refid='sqlGetUserInfoList' />
    <include refid='com.mobigen.cdev.mapper.mysql.core.paging.pagingPostSQL' />
  </select>

  <select id="getUserInfoListExcel" parameterType="map" resultType="java.util.HashMap">
		<include refid='sqlGetUserInfoList' />
	</select>

  <sql id="sqlGetUserInfoList">
    SELECT
        user_id,
        user_name,
        CONCAT(SUBSTRING(phone, 1, 3), '-', SUBSTRING(phone, 4,4), '-', SUBSTRING(phone,8)) AS phone,
        email,
        team_name
    FROM
      <include refid="def_table_system_manager" />
    WHERE 1=1 
      AND use_yn = 'Y'
      <if test = 'userId neq "" and userId neq null' >
        AND user_id like CONCAT(CONCAT('%', #{userId}), '%')
      </if>
      <if test = 'userNm neq "" and userNm neq null' >
        AND user_name like CONCAT(CONCAT('%', #{userNm}), '%')
      </if>
      <if test = 'teamInfo neq "" and teamInfo neq null' >
        AND team_name like CONCAT(CONCAT('%', #{teamInfo}), '%')
      </if>
  </sql>


  <!---->
  <!---->
  <select id="getNmsInfoList" parameterType="map" resultType="com.mobigen.cdev.poc.module.manage.dto.NmsInfoManageDto">
    <include refid='sqlGetNmsInfoList' />
  </select>

	<sql id="sqlGetNmsInfoList">
		SELECT
				A.system_cd 
			,	A.system_nm
			,	IFNULL(B.charge_info, '-') charge_info
			,	IFNULL(A.description , '-') description
			,	IFNULL(B.user_name, '-') user_name
			,	IFNULL(B.user_id, '-') user_id
			,	IFNULL(B.team_name, '-') team_name
			,	IFNULL(B.phone, '-') phone
			FROM <include refid="def_table_system_code" /> A
      <!--
      <choose>
        <when test = '(managerList != null and managerList.size != 0) or (teamInfo neq "" and teamInfo neq null)'>
          INNER JOIN
        </when>
        <otherwise>
          LEFT OUTER JOIN
        </otherwise>
      </choose>
      -->
      LEFT OUTER JOIN
				(
					SELECT
						system_cd
					,	LTRIM(GROUP_CONCAT(CONCAT(' ', B.user_name, '(', A.user_id, ' ', phone, ' ', team_name, ')'  ) ORDER BY B.user_name)) charge_info
					,	LTRIM(GROUP_CONCAT(CONCAT(B.user_name) ORDER BY B.user_name)) user_name
					,	LTRIM(GROUP_CONCAT(CONCAT(A.user_id) ORDER BY B.user_name)) user_id
					,	LTRIM(GROUP_CONCAT(CONCAT(team_name) ORDER BY B.user_name)) team_name
					,	LTRIM(GROUP_CONCAT(CONCAT(phone) ORDER BY B.user_name)) phone
					FROM
						<include refid="def_table_system_code_manager_map" /> A
					  LEFT OUTER JOIN
            (
              SELECT user_id, user_name, team_name, phone FROM <include refid="def_table_system_manager" />
              WHERE use_yn = 'Y'
            ) B
					  ON A.user_id = B.user_id
					WHERE 1 = 1
					GROUP BY system_cd 
				) B
			ON A.system_cd = B.system_cd

      <if test = '(managerList != null and managerList.size != 0) or (teamInfo neq "" and teamInfo neq null)'>
        INNER JOIN
        (
          SELECT
            DISTINCT system_cd
          FROM
            <include refid="def_table_system_code_manager_map" /> A
            INNER JOIN
            <include refid="def_table_system_manager" /> B
            ON A.user_id = B.user_id
          WHERE B.use_yn = 'Y'
          <if test = 'managerList != null and managerList.size != 0' >
            <foreach item="item" index="index" collection="managerList" open=" AND ((" close="))" separator=") OR (">A.user_id = #{item}</foreach>
          </if>
          <if test = 'teamInfo neq "" and teamInfo neq null' >
            AND team_name like CONCAT(CONCAT('%', #{teamInfo}), '%')
          </if>
        ) C
        ON A.system_cd = C.system_cd
      </if>

			WHERE A.use_yn = 'Y'
			AND A.system_cd  != '2000'
			<if test = 'nmsList != null and nmsList.size != 0' >
				AND A.system_cd IN <foreach item="item" index="index" collection="nmsList" open="(" separator="," close=")">#{item}</foreach>
			</if>
			<!-- ORDER BY system_cd -->
      ORDER BY system_nm
	</sql>
	<select id ="getSelectNmsId" parameterType="map" resultType="map">
		SELECT
      system_cd 
		FROM
      <include refid="def_table_system_code" />
		ORDER BY system_cd desc
	</select>

	<select id="getNmsInfoListExcel" parameterType="map" resultType="java.util.HashMap">
		<include refid='sqlGetNmsInfoList' />
	</select>


  <!-- -->
  <!-- I/U/D -->
  <select id="existNmsInfoName" parameterType="map" resultType="int">
    SELECT 
      COUNT(*) EXIST_COUNT
    FROM
      <include refid="def_table_system_code" />
    WHERE system_nm  = #{nmsNm}
    <if test = 'applyType eq "MOD".toString()'>
      AND system_cd != #{nmsId}
    </if>
  </select>

  <select id="existNmsInfoInInterface" parameterType="map" resultType="int">
    SELECT
      SUM(INF.EXIST_COUNT) INF_EXIST_COUNT
    FROM
    (	
      SELECT COUNT(*) EXIST_COUNT 
      FROM
        <include refid="com.mobigen.cdev.mapper.mysql.module.collect.interfacesource.def_table_interface" />
      WHERE system_cd  = #{nmsId}
      UNION
      SELECT COUNT(*) EXIST_COUNT
      FROM
        <include refid="com.mobigen.cdev.mapper.mysql.module.provide.interfacesource.def_table_interface" />
      WHERE system_cd  = #{nmsId}
    ) INF
  </select>

  <update id = "updateNmsInfo" parameterType="map">
		UPDATE <include refid="def_table_system_code" />
			SET 
			<if test = 'nmsNm neq "" and nmsNm neq null'>
			  system_nm = #{nmsNm}
			</if>
			<if test = 'nmsDesc neq "" and nmsDesc neq null'>
			, description = #{nmsDesc}
			</if>
			, updated_at = SYSDATE()
      , updated_by = #{userId}
			WHERE 1=1 
		 	AND system_cd = #{nmsId}
	</update>

	<insert id ="insertNmsInfo" parameterType="map">
	 INSERT into <include refid="def_table_system_code" />
    (system_cd, system_nm, description, use_yn, created_at, updated_at, created_by, updated_by)
	 VALUES 
	 	(
			#{nmsId}
		, #{nmsNm}
		, #{nmsDesc}
		, 'Y'
		, SYSDATE()
		, SYSDATE()
    , #{userId}
    , #{userId}
		)
	</insert>

  <delete id="deleteNmsInfo" parameterType="map">
    DELETE FROM <include refid="def_table_system_code" />
    WHERE system_cd = #{nmsId}
  </delete>

  <delete id="deleteNmsManagerMap" parameterType="map">
    DELETE FROM <include refid="def_table_system_code_manager_map" />
    WHERE system_cd = #{nmsId}
  </delete>

  <!-- -->
  <!-- I/U/D -->

  <!---->
  <!---->
  <select id="getNmsChargeManageList" parameterType="map" resultType="com.mobigen.cdev.poc.module.manage.dto.NmsChargeManageDto">
    <include refid="sqlGetNmsChargeManageList" />
  </select>
  <select id="getNmsChargeManageListExcel" parameterType="map" resultType="java.util.HashMap">
    <include refid="sqlGetNmsChargeManageList" />
  </select>

  <sql id="sqlGetNmsChargeManageList">
    SELECT 
      A.system_cd 
    ,	A.system_nm
    , A.description
    , (
        SELECT
          LTRIM(GROUP_CONCAT(CONCAT(' ', B.user_name, '(', B.user_id, ' ', B.phone, ' ', B.team_name, ')'  ) ORDER BY B.user_name))
        FROM <include refid="def_table_system_manager" /> B
        WHERE 1=1 
        AND B.user_id IN 
        <foreach collection= "selectedItem" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>) AS charge_info
    , (
        SELECT
          LTRIM(GROUP_CONCAT(CONCAT(B.user_id ) ORDER BY B.user_name)) 
        FROM <include refid="def_table_system_manager" /> B
        WHERE 1=1 
        AND B.user_id IN 
         <foreach collection= "selectedItem" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>) AS user_id
    , (
        SELECT
          LTRIM(GROUP_CONCAT(CONCAT(B.phone ) ORDER BY B.user_name)) 
        FROM <include refid="def_table_system_manager" /> B
        WHERE 1=1 
        AND B.user_id IN 
         <foreach collection= "selectedItem" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>) AS phone
    , (
        SELECT
          LTRIM(GROUP_CONCAT(CONCAT(B.team_name ) ORDER BY B.user_name)) 
        FROM <include refid="def_table_system_manager" /> B
        WHERE 1=1 
        AND B.user_id IN 
        <foreach collection= "selectedItem" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>) AS team_name
    , (
        SELECT
          LTRIM(GROUP_CONCAT(CONCAT(B.user_name ) ORDER BY B.user_name)) 
        FROM <include refid="def_table_system_manager" /> B
        WHERE 1=1 
        AND B.user_id IN 
        <foreach collection= "selectedItem" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>) AS user_name
    FROM <include refid="def_table_system_code" /> A
    WHERE A.system_cd IN
      <foreach collection= "systemCode" item="code"  open="(" close=")" separator=",">
          #{code}
      </foreach>
    ORDER BY system_cd
  </sql>

  <select id="getManagerChangeStatus" parameterType="map" resultType="com.mobigen.cdev.poc.module.manage.dto.NmsChargeManageDto">
    SELECT
				A.system_cd 
			,	A.system_nm
			,	IFNULL(B.charge_info, '-') charge_info
			,	B.user_name
			,	B.team_name
			, B.user_id
			,	IFNULL(A.description , '-') description
			FROM <include refid="def_table_system_code" /> A
			LEFT OUTER JOIN 
				(
					SELECT
						system_cd
						,B.user_name user_name
						,B.team_name team_name
						,B.user_id user_id
					,	LTRIM(GROUP_CONCAT(CONCAT(' ', B.user_name, '(', A.user_id, ' ', phone, ' ', team_name, ')'  ) ORDER BY B.user_name)) charge_info
					FROM
						<include refid="def_table_system_code_manager_map" /> A
					LEFT OUTER JOIN	(SELECT user_id, user_name, team_name, phone FROM <include refid="def_table_system_manager" /> WHERE use_yn = 'Y') B
					ON A.user_id = B.user_id
					WHERE 1 = 1
					GROUP BY system_cd , user_name, team_name, user_id 
				) B
			ON A.system_cd = B.system_cd
      WHERE 
      <foreach collection= "selectedItem" item="item" separator=" AND ">
            B.user_id = #{item}
      </foreach>
      AND 
      <foreach collection= "systemCode" item="code" separator=" AND ">
            A.system_cd = #{code}
      </foreach>

  </select>

  <delete id = "deleteNmsChargeManage" parameterType="map">
    DELETE FROM <include refid="def_table_system_code_manager_map" />
    WHERE system_cd = #{systemCd}
  </delete>

  <insert id = "insertNmsChargeManage" parameterType="map">
    INSERT IGNORE INTO <include refid="def_table_system_code_manager_map" /> 
    (
      user_id
    , system_cd
    , created_at
    , updated_at
    , created_by
    , updated_by
    )
    VALUES 
    (
      #{chargeId}
    , #{systemCd}
    , SYSDATE()
    , SYSDATE()
    , #{userId}
    , #{userId}
    )
  </insert>

</mapper>